#!/bin/bash
# AegisIDE Framework Setup Script v3.1.0
# Automated installation for Windsurf, Cursor, VS Code

set -e  # Exit on error

echo "ğŸ¤– AegisIDE Framework Setup v3.1.0"
echo "======================================"
echo ""

# Detect OS
OS="$(uname -s)"
case "${OS}" in
    Linux*)     PLATFORM=Linux;;
    Darwin*)    PLATFORM=Mac;;
    MINGW*|MSYS*|CYGWIN*)    PLATFORM=Windows;;
    *)          PLATFORM="UNKNOWN:${OS}"
esac

echo "ğŸ“‹ Detected Platform: ${PLATFORM}"
echo ""

# Detect IDE
IDE_TYPE=""
if [ -d "${HOME}/.windsurf" ]; then
    IDE_TYPE="windsurf"
    IDE_PATH="${HOME}/.windsurf"
    echo "âœ“ Windsurf IDE detected"
elif [ -d "${HOME}/.cursor" ]; then
    IDE_TYPE="cursor"
    IDE_PATH="${HOME}/.cursor"
    echo "âœ“ Cursor IDE detected"
elif [ -d "${HOME}/.vscode" ]; then
    IDE_TYPE="vscode"
    IDE_PATH="${HOME}/.vscode"
    echo "âœ“ VS Code detected"
else
    echo "âš ï¸  No IDE detected. Please select:"
    echo "1) Windsurf"
    echo "2) Cursor"
    echo "3) VS Code"
    read -p "Enter choice (1-3): " ide_choice
    case ${ide_choice} in
        1) IDE_TYPE="windsurf"; IDE_PATH="${HOME}/.windsurf";;
        2) IDE_TYPE="cursor"; IDE_PATH="${HOME}/.cursor";;
        3) IDE_TYPE="vscode"; IDE_PATH="${HOME}/.vscode";;
        *) echo "âŒ Invalid choice"; exit 1;;
    esac
fi

echo ""
echo "ğŸ”§ Installing to: ${IDE_PATH}/aegiside"
echo ""

# Create directory structure
echo "ğŸ“ Creating directory structure..."
mkdir -p "${IDE_PATH}/aegiside"
mkdir -p "${IDE_PATH}/rules"
mkdir -p "${IDE_PATH}/workflow"

# Copy framework files (IMPORTANT: Copy not symlink)
echo "ğŸ“¦ Copying AegisIDE framework files..."
cp -r src/.aegiside/* "${IDE_PATH}/aegiside/"
cp -r src/rules/* "${IDE_PATH}/rules/"
cp -r src/workflow/* "${IDE_PATH}/workflow/"

echo "âœ“ Framework files copied"
echo ""

# Verify memory-bank is clean
echo "ğŸ§¹ Verifying memory-bank is clean..."
MEMORY_BANK="${IDE_PATH}/aegiside/memory-bank"
JSON_COUNT=$(find "${MEMORY_BANK}" -name "*.json" -not -name "RL_SCORING_EXAMPLE.json" | wc -l)

if [ ${JSON_COUNT} -gt 0 ]; then
    echo "âš ï¸  Found ${JSON_COUNT} JSON files in memory-bank (should be 0)"
    echo "   These will be generated by /init workflow"
fi

echo "âœ“ Memory-bank clean"
echo ""

# Configure MCP servers
echo "ğŸ”Œ Configuring MCP servers..."
MCP_CONFIG="${HOME}/mcp_servers.json"

if [ -f "${MCP_CONFIG}" ]; then
    echo "âš ï¸  MCP config already exists at ${MCP_CONFIG}"
    read -p "   Overwrite? (y/N): " overwrite
    if [ "${overwrite}" = "y" ] || [ "${overwrite}" = "Y" ]; then
        cp src/mcp_servers.json "${MCP_CONFIG}"
        echo "âœ“ MCP config updated"
    else
        echo "âŠ˜ Keeping existing config"
    fi
else
    cp src/mcp_servers.json "${MCP_CONFIG}"
    echo "âœ“ MCP config created"
fi

echo ""

# Check prerequisites
echo "ğŸ” Checking prerequisites..."

# Check Node.js
if command -v node &> /dev/null; then
    NODE_VERSION=$(node --version)
    echo "âœ“ Node.js ${NODE_VERSION}"
else
    echo "âŒ Node.js not found (required for MCP servers)"
    echo "   Install from: https://nodejs.org/"
fi

# Check Python
if command -v python3 &> /dev/null; then
    PYTHON_VERSION=$(python3 --version)
    echo "âœ“ ${PYTHON_VERSION}"
else
    echo "âš ï¸  Python not found (optional, for Python MCPs)"
fi

# Check uvx
if command -v uvx &> /dev/null; then
    echo "âœ“ uvx (for Python MCPs)"
else
    echo "âš ï¸  uvx not found (optional, for Python MCPs)"
    echo "   Install: curl -LsSf https://astral.sh/uv/install.sh | sh"
fi

# Check CLI tools (REQUIRED for 267x faster operations)
echo ""
echo "ğŸ› ï¸  Checking CLI tools..."

if command -v jq &> /dev/null; then
    JQ_VERSION=$(jq --version)
    echo "âœ“ jq ${JQ_VERSION}"
else
    echo "âŒ jq not found (REQUIRED - 167x faster)"
    echo "   Install: sudo apt-get install jq OR brew install jq"
fi

if command -v sponge &> /dev/null; then
    echo "âœ“ sponge (moreutils)"
else
    echo "âŒ sponge not found (REQUIRED - 267x faster atomic updates)"
    echo "   Install: sudo apt-get install moreutils OR brew install moreutils"
fi

if command -v glow &> /dev/null; then
    GLOW_VERSION=$(glow --version 2>&1 | head -1)
    echo "âœ“ glow ${GLOW_VERSION}"
else
    echo "âŒ glow not found (REQUIRED - markdown rendering)"
    echo "   Install: sudo snap install glow OR brew install glow"
fi

echo ""

# Test MCP servers (7 core MCPs)
echo "ğŸ§ª Testing MCP servers..."

# Test context7 (official docs)
if npx -y @upstash/context7-mcp@latest --version &> /dev/null; then
    echo "âœ“ context7 MCP working"
else
    echo "âš ï¸  context7 MCP test failed"
fi

# Test sequential-thinking (deep reasoning)
if npx -y @modelcontextprotocol/server-sequential-thinking --help &> /dev/null; then
    echo "âœ“ sequential-thinking MCP working"
else
    echo "âš ï¸  sequential-thinking MCP test failed"
fi

# Test memory (knowledge graph)
if npx -y @modelcontextprotocol/server-memory --help &> /dev/null; then
    echo "âœ“ memory MCP working"
else
    echo "âš ï¸  memory MCP test failed"
fi

echo ""

# Final instructions
echo "âœ… AegisIDE Setup Complete!"
echo ""
echo "ğŸ“š Next Steps:"
echo "   1. Open your IDE (${IDE_TYPE})"
echo "   2. Start AI assistant"
echo "   3. Type: /init"
echo "   4. AI will auto-generate 8 memory-bank files"
echo ""
echo "ğŸ“– Documentation: README.md"
echo "ğŸ”§ Troubleshooting: Run ./validate-setup.sh"
echo ""
echo "ğŸ’¡ CLI Tools Status:"
if command -v jq &> /dev/null && command -v sponge &> /dev/null && command -v glow &> /dev/null; then
    echo "   âœ… All CLI tools installed (267x faster operations)"
else
    echo "   âš ï¸  Missing CLI tools (see installation instructions above)"
fi
echo ""
echo "ğŸ‰ Happy autonomous coding!"
