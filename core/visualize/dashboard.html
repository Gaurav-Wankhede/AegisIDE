<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Bank Dashboard - ServeUPSC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
</head>
<body class="bg-black text-gray-100">
    <header class="bg-gray-900 border-b border-gray-800 sticky top-0 z-50 backdrop-blur-sm bg-opacity-95">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">ğŸ§  Memory Bank Dashboard</h1>
                    <p class="text-sm text-gray-500 mt-1">Real-time visualization of 17 JSON context files</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="loadAll()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg transition shadow-lg">ğŸ”„ Manual Refresh</button>
                    <button onclick="toggleAuto()" id="autoBtn" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg transition shadow-lg animate-pulse">â±ï¸ Auto: ON (5m)</button>
                </div>
            </div>
            <div class="mt-2 text-xs text-gray-600" id="status">ğŸš€ Loading dashboard...</div>
        </div>
    </header>

    <!-- Dynamic Component-Driven Dashboard -->
    <div class="container mx-auto px-6 py-8 space-y-8" id="dashboard">
        <div class="text-center text-gray-400">â³ Initializing components...</div>
    </div>

    <!-- Load all component scripts FIRST -->
    <script src="components/activecontext-component.js"></script>
    <script src="components/scratchpad-component.js"></script>
    <script src="components/progress-component.js"></script>
    <script src="components/mistakes-component.js"></script>
    <script src="components/projectbrief-component.js"></script>
    <script src="components/systempatterns-component.js"></script>
    <script src="components/techcontext-component.js"></script>
    <script src="components/productcontext-component.js"></script>
    <script src="components/roadmap-component.js"></script>
    <script src="components/kanban-component.js"></script>
    <script src="components/blueprint-component.js"></script>
    <script src="components/bugfix-component.js"></script>
    <script src="components/deployment-component.js"></script>
    <script src="components/monitoring-component.js"></script>
    <script src="components/dependencies-component.js"></script>
    <script src="components/userflow-component.js"></script>
    <script src="components/mermaid-component.js"></script>

    <script>
        // Global variables
        let data = {};
        let components = {};
        let autoRefresh = null;

        // Initialize Mermaid
        mermaid.initialize({
            startOnLoad: false,
            theme: 'dark',
            themeVariables: {
                darkMode: true,
                background: '#0f172a',
                primaryColor: '#3b82f6',
                primaryTextColor: '#f1f5f9',
                primaryBorderColor: '#1e40af',
                lineColor: '#64748b',
                secondaryColor: '#10b981',
                tertiaryColor: '#f59e0b',
                fontSize: '14px',
                fontFamily: 'Inter, system-ui, sans-serif'
            }
        });

        // Load JSON data from parent directory
        async function loadData() {
            const jsonFiles = [
                'activeContext.json', 'scratchpad.json', 'mistakes.json', 'progress.json',
                'systemPatterns.json', 'techContext.json', 'productContext.json', 'projectbrief.json',
                'roadmap.json', 'kanban.json', 'blueprint.json', 'bugfix.json',
                'deployment.json', 'monitoring.json', 'dependencies.json', 'userflow.json', 'mermaid.json'
            ];

            console.log('ğŸ“¡ Loading JSON files from parent directory...');
            console.log('ğŸ“‚ Current location:', window.location.href);
            console.log('ğŸ“‚ Loading from path: ../');
            
            const loadPromises = jsonFiles.map(async (file) => {
                const filePath = `../${file}`;
                console.log(`ğŸ” Attempting to load: ${filePath}`);
                
                try {
                    const response = await fetch(filePath);
                    console.log(`ğŸ“¥ Response for ${file}:`, response.status, response.statusText);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const fileData = await response.json();
                    console.log(`âœ… Loaded ${file}:`, Object.keys(fileData).length, 'keys');
                    return { [file]: fileData };
                } catch (error) {
                    console.error(`âŒ Failed to load ${file}:`, error.message, error);
                    return { [file]: null };
                }
            });

            const results = await Promise.all(loadPromises);
            const loadedData = results.reduce((acc, result) => ({ ...acc, ...result }), {});
            const successCount = Object.values(loadedData).filter(v => v !== null).length;
            console.log(`ğŸ“Š Data loading complete: ${successCount}/${jsonFiles.length} files loaded`);
            console.log('ğŸ“Š Loaded files:', Object.keys(loadedData).filter(k => loadedData[k] !== null));
            return loadedData;
        }

        // Initialize all component instances
        function initializeComponents() {
            try {
                console.log('ğŸ”§ Initializing components...');
                components = {
                    activeContext: new ActiveContextComponent(),
                    scratchpad: new ScratchpadComponent(),
                    progress: new ProgressComponent(),
                    mistakes: new MistakesComponent(),
                    projectbrief: new ProjectBriefComponent(),
                    systemPatterns: new SystemPatternsComponent(),
                    techContext: new TechContextComponent(),
                    productContext: new ProductContextComponent(),
                    roadmap: new RoadmapComponent(),
                    kanban: new KanbanComponent(),
                    blueprint: new BlueprintComponent(),
                    bugfix: new BugfixComponent(),
                    deployment: new DeploymentComponent(),
                    monitoring: new MonitoringComponent(),
                    dependencies: new DependenciesComponent(),
                    userflow: new UserflowComponent(),
                    mermaid: new MermaidComponent()
                };
                console.log('âœ… Components initialized:', Object.keys(components).length);
                return true;
            } catch (error) {
                console.error('âŒ Component initialization failed:', error);
                return false;
            }
        }

        // Generate overview statistics from loaded data
        function generateOverviewStats() {
            const loadedCount = Object.keys(data).filter(key => data[key] !== null).length;
            const activeTasks = data['scratchpad.json']?.immediate_priorities?.length || 0;
            const completedMilestones = data['progress.json']?.development_milestones?.filter(m => m.status === 'completed')?.length || 0;
            const totalIssues = data['mistakes.json']?.error_patterns?.length || 0;
            
            return [
                { title: 'Active Tasks', value: activeTasks, color: 'blue' },
                { title: 'Completed', value: completedMilestones, color: 'green' },
                { title: 'Issues', value: totalIssues, color: 'red' },
                { title: 'Schema Health', value: `${Math.round((loadedCount/17)*100)}%`, color: 'purple' }
            ];
        }

        // Render complete dashboard using components
        function render() {
            const dashboardContainer = document.getElementById('dashboard');
            if (!dashboardContainer) {
                console.error('âŒ Dashboard container not found');
                return;
            }

            if (!components || Object.keys(components).length === 0) {
                console.error('âŒ Components not initialized');
                dashboardContainer.innerHTML = '<div class="text-red-400 text-center">âŒ Components not loaded</div>';
                return;
            }

            try {
                const overviewData = generateOverviewStats();
                
                dashboardContainer.innerHTML = `
                    <!-- Overview Cards -->
                    <section>
                        <h2 class="text-2xl font-bold mb-4 text-blue-400">ğŸ“Š System Overview</h2>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            ${overviewData.map(item => `
                                <div class="bg-gray-900 rounded-xl p-6 border border-gray-800 shadow-xl">
                                    <h3 class="text-lg font-bold text-${item.color}-400 mb-2">${item.title}</h3>
                                    <div class="text-3xl font-bold text-white">${item.value}</div>
                                </div>
                            `).join('')}
                        </div>
                    </section>

                    <!-- Active Context & Scratchpad -->
                    <section>
                        <h2 class="text-2xl font-bold mb-4 text-cyan-400">ğŸ”„ Current Activity</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-gray-900 rounded-xl p-6 border border-gray-800 shadow-xl">
                                ${components.activeContext.render(data)}
                            </div>
                            <div class="bg-gray-900 rounded-xl p-6 border border-gray-800 shadow-xl">
                                ${components.scratchpad.render(data)}
                            </div>
                        </div>
                    </section>

                    <!-- Kanban Board -->
                    <section>
                        <h2 class="text-2xl font-bold mb-4 text-yellow-400">ğŸ“‹ Task Management</h2>
                        <div class="bg-gray-900 rounded-xl p-6 border border-gray-800 shadow-xl">
                            ${components.kanban.render(data)}
                        </div>
                    </section>

                    <!-- Progress & Roadmap -->
                    <section>
                        <h2 class="text-2xl font-bold mb-4 text-green-400">ğŸ“ˆ Progress & Strategy</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-gray-900 rounded-xl p-6 border border-gray-800 shadow-xl">
                                ${components.progress.render(data)}
                            </div>
                            <div class="bg-gray-900 rounded-xl p-6 border border-gray-800 shadow-xl">
                                ${components.roadmap.render(data)}
                            </div>
                        </div>
                    </section>

                    <!-- Issues & Learning -->
                    <section>
                        <h2 class="text-2xl font-bold mb-4 text-red-400">ğŸ› Quality & Learning</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-gray-900 rounded-xl p-6 border border-red-600/30">
                                ${components.bugfix.render(data)}
                            </div>
                            <div class="bg-gray-900 rounded-xl p-6 border border-orange-600/30">
                                ${components.mistakes.render(data)}
                            </div>
                        </div>
                    </section>

                    <!-- Architecture & Design -->
                    <section>
                        <h2 class="text-2xl font-bold mb-4 text-cyan-400">ğŸ¨ Architecture</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-gray-900 rounded-xl p-6 border border-gray-800 shadow-xl">
                                ${components.blueprint.render(data)}
                            </div>
                            <div class="bg-gray-900 rounded-xl p-6 border border-gray-800 shadow-xl">
                                ${components.userflow.render(data)}
                            </div>
                        </div>
                    </section>

                    <!-- Technical Context -->
                    <section>
                        <h2 class="text-2xl font-bold mb-4 text-indigo-400">ğŸ”§ Technical Stack</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-gray-900 rounded-xl p-6 border border-gray-800 shadow-xl">
                                ${components.techContext.render(data)}
                            </div>
                            <div class="bg-gray-900 rounded-xl p-6 border border-gray-800 shadow-xl">
                                ${components.dependencies.render(data)}
                            </div>
                            <div class="bg-gray-900 rounded-xl p-6 border border-gray-800 shadow-xl">
                                ${components.systemPatterns.render(data)}
                            </div>
                        </div>
                    </section>

                    <!-- Operations -->
                    <section>
                        <h2 class="text-2xl font-bold mb-4 text-pink-400">ğŸš€ Operations</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-gray-900 rounded-xl p-6 border border-gray-800 shadow-xl">
                                ${components.deployment.render(data)}
                            </div>
                            <div class="bg-gray-900 rounded-xl p-6 border border-gray-800 shadow-xl">
                                ${components.monitoring.render(data)}
                            </div>
                        </div>
                    </section>

                    <!-- Business Context -->
                    <section>
                        <h2 class="text-2xl font-bold mb-4 text-amber-400">ğŸ“¦ Business Context</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-gray-900 rounded-xl p-6 border border-gray-800 shadow-xl">
                                ${components.productContext.render(data)}
                            </div>
                            <div class="bg-gray-900 rounded-xl p-6 border border-gray-800 shadow-xl">
                                ${components.projectbrief.render(data)}
                            </div>
                        </div>
                    </section>

                    <!-- Workflow Visualization -->
                    <section>
                        <h2 class="text-2xl font-bold mb-4 text-violet-400">ğŸ¯ Workflow Visualization</h2>
                        <div class="bg-gray-900 rounded-xl p-6 shadow-xl border border-gray-800">
                            ${components.mermaid.render(data)}
                        </div>
                    </section>
                `;
                
                console.log('âœ… Dashboard rendered successfully');
            } catch (error) {
                console.error('âŒ Render failed:', error);
                dashboardContainer.innerHTML = `<div class="text-red-400 text-center">âŒ Render error: ${error.message}</div>`;
            }
        }

        // Main load function
        async function loadAll() {
            try {
                document.getElementById('status').textContent = 'â³ Initializing components...';
                
                if (!initializeComponents()) {
                    document.getElementById('status').textContent = 'âŒ Component initialization failed';
                    return;
                }
                
                document.getElementById('status').textContent = 'â³ Loading JSON data...';
                data = await loadData();
                
                document.getElementById('status').textContent = 'â³ Rendering dashboard...';
                render();
                
                const loadedCount = Object.keys(data).filter(key => data[key] !== null).length;
                document.getElementById('status').textContent = 
                    `âœ… Updated: ${new Date().toLocaleTimeString()} - ${loadedCount}/17 files loaded`;
                    
                console.log('ğŸ¯ Dashboard loaded successfully');
            } catch (error) {
                console.error('âŒ Dashboard load failed:', error);
                document.getElementById('status').textContent = `âŒ Load failed: ${error.message}`;
            }
        }

        // Auto-refresh toggle
        function toggleAuto() {
            const btn = document.getElementById('autoBtn');
            if (autoRefresh) {
                clearInterval(autoRefresh);
                autoRefresh = null;
                btn.textContent = 'â±ï¸ Auto: OFF';
                btn.classList.remove('bg-green-600', 'animate-pulse');
                btn.classList.add('bg-gray-800');
            } else {
                autoRefresh = setInterval(loadAll, 300000); // 5 minutes for optimal performance
                btn.textContent = 'â±ï¸ Auto: ON (5m)';
                btn.classList.remove('bg-gray-800');
                btn.classList.add('bg-green-600', 'animate-pulse');
            }
        }

        // Start auto-refresh automatically
        function startAutoRefresh() {
            if (!autoRefresh) {
                autoRefresh = setInterval(loadAll, 300000);
                const btn = document.getElementById('autoBtn');
                btn.textContent = 'â±ï¸ Auto: ON (5m)';
                btn.classList.remove('bg-gray-800');
                btn.classList.add('bg-green-600', 'animate-pulse');
            }
        }

        // Global function exports
        window.loadAll = loadAll;
        window.toggleAuto = toggleAuto;

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ DOM ready, initializing dashboard...');
            loadAll();
            
            // Start auto-refresh automatically after initial load
            setTimeout(() => {
                startAutoRefresh();
                console.log('âœ… Auto-refresh enabled: 5-minute intervals');
            }, 2000);
        });
    </script>
</body>
</html>
