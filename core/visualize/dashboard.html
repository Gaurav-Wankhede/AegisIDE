<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AegisIDE Memory Bank Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Minimal dashboard does not depend on mermaid or chart.js -->
</head>
<body class="bg-black text-gray-100">
    <header class="bg-gray-900 border-b border-gray-800 sticky top-0 z-50 backdrop-blur-sm bg-opacity-95">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">üß† Memory Bank Dashboard</h1>
                    <p class="text-sm text-gray-500 mt-1">Real-time visualization of 7 JSON memory-bank files</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="loadAll()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg transition shadow-lg">üîÑ Manual Refresh</button>
                    <button onclick="toggleAuto()" id="autoBtn" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg transition shadow-lg animate-pulse">‚è±Ô∏è Auto: ON (5m)</button>
                </div>
            </div>
            <div class="mt-2 text-xs text-gray-600" id="status">üöÄ Loading dashboard...</div>
        </div>
    </header>

    <!-- Dynamic Component-Driven Dashboard -->
    <div class="container mx-auto px-6 py-8 space-y-8" id="dashboard">
        <div class="text-center text-gray-400">‚è≥ Initializing components...</div>
    </div>

    <!-- Minimalized: no external component scripts -->

    <script>
        // Global state
        let data = {};
        let autoRefresh = null;

        // Load JSON data from parent directory
        async function loadData() {
            const jsonFiles = [
                'activeContext.json',
                'scratchpad.json',
                'mistakes.json',
                'progress.json',
                'systemPatterns.json',
                'roadmap.json',
                'kanban.json'
            ];

            console.log('üì° Loading JSON files from parent directory...');
            console.log('üìÇ Current location:', window.location.href);
            console.log('üìÇ Loading from path: ../');
            
            const loadPromises = jsonFiles.map(async (file) => {
                const filePath = `../${file}`;
                console.log(`üîç Attempting to load: ${filePath}`);
                
                try {
                    const response = await fetch(filePath);
                    console.log(`üì• Response for ${file}:`, response.status, response.statusText);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const fileData = await response.json();
                    console.log(`‚úÖ Loaded ${file}:`, Object.keys(fileData).length, 'keys');
                    return { [file]: fileData };
                } catch (error) {
                    console.error(`‚ùå Failed to load ${file}:`, error.message, error);
                    return { [file]: null };
                }
            });

            const results = await Promise.all(loadPromises);
            const loadedData = results.reduce((acc, result) => ({ ...acc, ...result }), {});
            const successCount = Object.values(loadedData).filter(v => v !== null).length;
            console.log(`üìä Data loading complete: ${successCount}/${jsonFiles.length} files loaded`);
            console.log('üìä Loaded files:', Object.keys(loadedData).filter(k => loadedData[k] !== null));
            return loadedData;
        }

        // Generate overview statistics from loaded data
        function generateOverviewStats() {
            const loadedCount = Object.keys(data).filter(key => data[key] !== null).length;
            const activeTasks = data['scratchpad.json']?.immediate_priorities?.length || 0;
            const completedMilestones = data['progress.json']?.milestone_tracking?.filter(m => m.status === 'completed')?.length || 0;
            const totalIssues = data['mistakes.json']?.error_patterns?.length || 0;
            
            return [
                { title: 'Active Tasks', value: activeTasks, color: 'blue' },
                { title: 'Completed', value: completedMilestones, color: 'green' },
                { title: 'Issues', value: totalIssues, color: 'red' },
                { title: 'Schema Health', value: `${Math.round((loadedCount/7)*100)}%`, color: 'purple' }
            ];
        }

        // Render minimal dashboard (7 schemas)
        function render() {
            const dashboardContainer = document.getElementById('dashboard');
            if (!dashboardContainer) {
                console.error('‚ùå Dashboard container not found');
                return;
            }

            try {
                const overviewData = generateOverviewStats();
                
                dashboardContainer.innerHTML = `
                    <!-- Overview Cards -->
                    <section>
                        <h2 class="text-2xl font-bold mb-4 text-blue-400">üìä System Overview</h2>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            ${overviewData.map(item => `
                                <div class="bg-gray-900 rounded-xl p-6 border border-gray-800 shadow-xl">
                                    <h3 class="text-lg font-bold text-${item.color}-400 mb-2">${item.title}</h3>
                                    <div class="text-3xl font-bold text-white">${item.value}</div>
                                </div>
                            `).join('')}
                        </div>
                    </section>
                    <!-- Minimal JSON Sections -->
                    <section>
                        <h2 class="text-2xl font-bold mb-4 text-cyan-400">üîÑ Current Activity</h2>
                        ${renderJsonCard('activeContext.json', 'Active Context')}
                        ${renderJsonCard('scratchpad.json', 'Scratchpad')}
                    </section>

                    <section>
                        <h2 class="text-2xl font-bold mb-4 text-yellow-400">üìã Task Management</h2>
                        ${renderJsonCard('kanban.json', 'Kanban')}
                    </section>

                    <section>
                        <h2 class="text-2xl font-bold mb-4 text-green-400">üìà Progress & Strategy</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                          ${renderJsonCard('progress.json', 'Progress')}
                          ${renderJsonCard('roadmap.json', 'Roadmap')}
                        </div>
                    </section>

                    <section>
                        <h2 class="text-2xl font-bold mb-4 text-red-400">üêõ Quality & Patterns</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                          ${renderJsonCard('mistakes.json', 'Mistakes')}
                          ${renderJsonCard('systemPatterns.json', 'System Patterns')}
                        </div>
                    </section>
                `;
                
                console.log('‚úÖ Dashboard rendered successfully');
            } catch (error) {
                console.error('‚ùå Render failed:', error);
                dashboardContainer.innerHTML = `<div class="text-red-400 text-center">‚ùå Render error: ${error.message}</div>`;
            }
        }

        // Helper to render JSON in a card
        function renderJsonCard(key, title) {
            const obj = data[key];
            const body = obj ? `<pre class="text-xs whitespace-pre-wrap">${escapeHtml(JSON.stringify(obj, null, 2))}</pre>`
                             : `<div class="text-gray-500">Not loaded</div>`;
            return `
              <div class="bg-gray-900 rounded-xl p-6 border border-gray-800 shadow-xl mb-4">
                <h3 class="text-lg font-bold text-white mb-2">${title}</h3>
                ${body}
              </div>
            `;
        }

        // Escape HTML for safe JSON rendering
        function escapeHtml(str) {
          return str
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;');
        }

        // Main load function
        async function loadAll() {
            try {
                document.getElementById('status').textContent = '‚è≥ Loading JSON data...';
                data = await loadData();
                
                document.getElementById('status').textContent = '‚è≥ Rendering dashboard...';
                render();
                
                const loadedCount = Object.keys(data).filter(key => data[key] !== null).length;
                document.getElementById('status').textContent = 
                    `‚úÖ Updated: ${new Date().toLocaleTimeString()} - ${loadedCount}/7 files loaded`;
                    
                console.log('üéØ Dashboard loaded successfully');
            } catch (error) {
                console.error('‚ùå Dashboard load failed:', error);
                document.getElementById('status').textContent = `‚ùå Load failed: ${error.message}`;
            }
        }

        // Auto-refresh toggle
        function toggleAuto() {
            const btn = document.getElementById('autoBtn');
            if (autoRefresh) {
                clearInterval(autoRefresh);
                autoRefresh = null;
                btn.textContent = '‚è±Ô∏è Auto: OFF';
                btn.classList.remove('bg-green-600', 'animate-pulse');
                btn.classList.add('bg-gray-800');
            } else {
                autoRefresh = setInterval(loadAll, 300000); // 5 minutes for optimal performance
                btn.textContent = '‚è±Ô∏è Auto: ON (5m)';
                btn.classList.remove('bg-gray-800');
                btn.classList.add('bg-green-600', 'animate-pulse');
            }
        }

        // Start auto-refresh automatically
        function startAutoRefresh() {
            if (!autoRefresh) {
                autoRefresh = setInterval(loadAll, 300000);
                const btn = document.getElementById('autoBtn');
                btn.textContent = '‚è±Ô∏è Auto: ON (5m)';
                btn.classList.remove('bg-gray-800');
                btn.classList.add('bg-green-600', 'animate-pulse');
            }
        }

        // Global function exports
        window.loadAll = loadAll;
        window.toggleAuto = toggleAuto;

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOM ready, initializing dashboard...');
            loadAll();
            
            // Start auto-refresh automatically after initial load
            setTimeout(() => {
                startAutoRefresh();
                console.log('‚úÖ Auto-refresh enabled: 5-minute intervals');
            }, 2000);
        });
    </script>
</body>
</html>
