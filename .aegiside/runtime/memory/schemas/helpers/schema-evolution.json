{
  "schema_version": "1.0.0",
  "last_updated": "2025-10-17T16:24:00+05:30",
  "description": "Schema migration, deprecation, and atomicity protocols fixing Gaps 31-33",
  
  "schema_migration": {
    "description": "Gap 31 fix: Strategy for upgrading schemas across versions",
    "current_schema_version": "1.0.0",
    "migration_available": false,
    "migrations": [
      {
        "from_version": "1.0.0",
        "to_version": "2.0.0",
        "migration_script_path": "schemas/migrations/v1_to_v2_migration.py",
        "backward_compatible": false,
        "requires_backup": true,
        "rollback_available": true,
        "tested": false,
        "release_date": null
      }
    ],
    "migration_protocol": {
      "pre_migration_steps": [
        "Backup all 8 schema files to .aegiside/backups/YYYY-MM-DD_HH-MM-SS/",
        "Git commit current state",
        "Validate current schema integrity",
        "Create rollback point in progress.json rl_model_state"
      ],
      "migration_steps": [
        "Load migration script",
        "Dry-run migration (preview changes)",
        "User approval required",
        "Execute migration atomically",
        "Validate migrated schemas",
        "Update schema_version in all files"
      ],
      "post_migration_steps": [
        "Verify all 8 schemas valid",
        "Run schema-integrity-validator.json checks",
        "Git commit with migration tag",
        "Update constitution if schema changes affect governance"
      ],
      "rollback_steps": [
        "Restore from backup",
        "Git revert to pre-migration commit",
        "Restore RL model state",
        "Validate rollback success"
      ]
    }
  },
  
  "deprecation_policy": {
    "description": "Gap 32 fix: Phasing out old fields gracefully",
    "deprecated_fields": [
      {
        "schema": "memory.schema.json",
        "field": "total_rl_score",
        "deprecated_in_version": "1.0.0",
        "remove_in_version": "2.0.0",
        "replacement_field": "rl_source_ref",
        "migration_rule": "Replace with {rl_source_ref: 'progress.json'}",
        "warning_shown": true,
        "removal_date": "2026-01-01"
      }
    ],
    "deprecation_lifecycle": {
      "phase_1_warning": {
        "duration_months": 3,
        "action": "Log warning when deprecated field used",
        "user_notification": true
      },
      "phase_2_error": {
        "duration_months": 3,
        "action": "Throw error but still function with warning",
        "migration_prompt": true
      },
      "phase_3_removal": {
        "action": "Field removed completely",
        "requires_major_version_bump": true
      }
    }
  },
  
  "atomic_transaction_protocol": {
    "description": "Gap 33 fix: All-or-nothing schema updates across 8 files",
    "transaction_active": false,
    "current_transaction": null,
    "transaction_log": [],
    "protocol": {
      "begin_transaction": {
        "action": "Create transaction ID",
        "lock_schemas": ["activeContext", "scratchpad", "kanban", "mistakes", "systemPatterns", "progress", "roadmap", "memory"],
        "create_shadow_copies": true,
        "timestamp_start": null
      },
      "update_schema": {
        "action": "Update shadow copy only",
        "validate_immediately": true,
        "rollback_on_validation_failure": true
      },
      "commit_transaction": {
        "preconditions": ["All 8 schemas valid", "Schema integrity validator passes", "Checksums match"],
        "action": "Atomically replace all 8 files",
        "method": "Rename shadow copies to production",
        "on_failure": "Rollback to original files",
        "git_commit_required": true
      },
      "rollback_transaction": {
        "action": "Delete shadow copies",
        "restore_original_files": true,
        "log_failure_reason": true,
        "notify_user": true
      }
    },
    "atomic_guarantees": {
      "all_or_none": true,
      "no_partial_updates": true,
      "crash_recovery": "Shadow copies auto-cleanup on restart",
      "max_transaction_duration_minutes": 5
    }
  }
}
